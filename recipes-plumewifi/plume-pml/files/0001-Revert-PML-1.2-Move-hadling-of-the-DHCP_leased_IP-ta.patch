From 95ca8273b8bb8eb1aceafdaa98bea3a210b14e92 Mon Sep 17 00:00:00 2001
From: Bartosz Markowski <bartosz@plume.com>
Date: Sat, 22 Sep 2018 07:10:54 +0200
Subject: [PATCH] Revert "PML-1.2: Move hadling of the DHCP_leased_IP table
 from WM2 to NM2\"

Signed-off-by: Bartosz Markowski <bartosz@plume.com>
---
 src/nm2/src/nm2.h            |  1 -
 src/nm2/src/nm2_dhcp_table.c | 99 --------------------------------------------
 src/nm2/src/nm2_main.c       |  1 -
 src/nm2/unit.mk              |  1 -
 src/wm2/src/wm2.h            |  1 +
 src/wm2/src/wm2_dhcp_table.c | 99 ++++++++++++++++++++++++++++++++++++++++++++
 src/wm2/src/wm2_main.c       |  1 +
 src/wm2/unit.mk              |  1 +
 8 files changed, 102 insertions(+), 102 deletions(-)
 create mode 100644 src/wm2/src/wm2_dhcp_table.c

diff --git a/src/nm2/src/nm2.h b/src/nm2/src/nm2.h
index 91eb21a..9c560ea 100644
--- a/src/nm2/src/nm2.h
+++ b/src/nm2/src/nm2.h
@@ -34,7 +34,6 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 void nm2_ovsdb_init(void);
 bool nm2_mac_learning_init(void);
 bool nm2_client_nickname_init(void);
-bool nm2_dhcp_table_init(void);
 bool nm2_dhcp_rip_init(void);
 
 #endif
diff --git a/src/nm2/src/nm2_dhcp_table.c b/src/nm2/src/nm2_dhcp_table.c
index 8d464d2..c294c50 100644
--- a/src/nm2/src/nm2_dhcp_table.c
+++ b/src/nm2/src/nm2_dhcp_table.c
@@ -24,102 +24,3 @@ ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
 
-#include <stdlib.h>
-#include <sys/wait.h>
-#include <stdint.h>
-#include <errno.h>
-#include <limits.h>
-#include <string.h>
-#include <unistd.h>
-#include <arpa/inet.h>
-#include <netinet/in.h>
-#include <signal.h>
-#include <inttypes.h>
-#include <jansson.h>
-
-#include "json_util.h"
-#include "evsched.h"
-#include "schema.h"
-#include "log.h"
-#include "nm2.h"
-#include "ovsdb.h"
-#include "ovsdb_sync.h"
-
-#include "target.h"
-
-// Defines
-#define MODULE_ID LOG_MODULE_ID_MAIN
-
-// OVSDB constants
-#define OVSDB_DHCP_TABLE            "DHCP_leased_IP"
-
-static bool                         g_dhcp_table_init = false;
-
-/******************************************************************************
- *  PROTECTED definitions
- *****************************************************************************/
-static bool
-nm2_dhcp_table_update(struct schema_DHCP_leased_IP       *dlip)
-{
-    pjs_errmsg_t        perr;
-    json_t             *where, *row;
-    bool                ret;
-
-    LOGT("Updating DHCP lease '%s'",
-         dlip->hwaddr);
-
-    /* Skip deleting the empty entries at startup */
-    if(!g_dhcp_table_init && (dlip->lease_time == 0))
-    {
-        return true;
-    }
-
-    if (dlip->lease_time == 0)  {
-        // Released or expired lease... remove from OVSDB
-        where = ovsdb_tran_cond(OCLM_STR, "hwaddr", OFUNC_EQ, str_tolower(dlip->hwaddr));
-        ret = ovsdb_sync_delete_where(OVSDB_DHCP_TABLE, where);
-        if (!ret) {
-            LOGE("Updating DHCP lease %s (Failed to remove entry)",
-                dlip->hwaddr);
-            return false;
-        }
-        LOGN("Removed DHCP lease '%s' with '%s' '%s' '%d'",
-             dlip->hwaddr, dlip->inet_addr, dlip->hostname, dlip->lease_time);
-
-    }
-    else {
-        // New/active lease, upsert it into OVSDB
-        where = ovsdb_tran_cond(OCLM_STR, "hwaddr", OFUNC_EQ, str_tolower(dlip->hwaddr));
-        row   = schema_DHCP_leased_IP_to_json(dlip, perr);
-        ret = ovsdb_sync_upsert_where(OVSDB_DHCP_TABLE, where, row, NULL);
-        if (!ret) {
-            LOGE("Updating DHCP lease %s (Failed to insert entry)",
-                dlip->hwaddr);
-            return false;
-        }
-        LOGN("Updated DHCP lease '%s' with '%s' '%s' '%d'",
-             dlip->hwaddr, dlip->inet_addr, dlip->hostname, dlip->lease_time);
-
-    }
-
-    return true;
-}
-
-/******************************************************************************
- *  PUBLIC definitions
- *****************************************************************************/
-bool
-nm2_dhcp_table_init(void)
-{
-    bool         ret;
-
-    /* Register to DHCP lease changed ... */
-    ret = target_dhcp_leased_ip_register(nm2_dhcp_table_update);
-    if (false == ret) {
-        return false;
-    }
-
-    g_dhcp_table_init = true;
-
-    return true;
-}
diff --git a/src/nm2/src/nm2_main.c b/src/nm2/src/nm2_main.c
index ed66ef8..b5ed665 100644
--- a/src/nm2/src/nm2_main.c
+++ b/src/nm2/src/nm2_main.c
@@ -101,7 +101,6 @@ int main(int argc, char ** argv)
 
     nm2_ovsdb_init();
     nm2_mac_learning_init();
-    nm2_dhcp_table_init();
     nm2_dhcp_rip_init();
 
 
diff --git a/src/nm2/unit.mk b/src/nm2/unit.mk
index 1c4d38a..3de2066 100644
--- a/src/nm2/unit.mk
+++ b/src/nm2/unit.mk
@@ -35,7 +35,6 @@ UNIT_TYPE := BIN
 UNIT_SRC    := src/nm2_main.c
 UNIT_SRC    += src/nm2_ovsdb.c
 UNIT_SRC    += src/nm2_mac_learning.c
-UNIT_SRC    += src/nm2_dhcp_table.c
 UNIT_SRC    += src/nm2_dhcp_rip.c
 
 UNIT_CFLAGS += -Isrc/lib/common/inc/
diff --git a/src/wm2/src/wm2.h b/src/wm2/src/wm2.h
index c66e313..abda306 100644
--- a/src/wm2/src/wm2.h
+++ b/src/wm2/src/wm2.h
@@ -40,6 +40,7 @@ extern ovsdb_table_t table_Wifi_Associated_Clients;
 int     wm2_radio_init(void);
 
 bool    wm2_clients_init(char *ssid);
+bool    wm2_dhcp_table_init(void);
 
 bool    wm2_clients_update(struct schema_Wifi_Associated_Clients *client,
                            char *vif,
diff --git a/src/wm2/src/wm2_dhcp_table.c b/src/wm2/src/wm2_dhcp_table.c
new file mode 100644
index 0000000..c3be003
--- /dev/null
+++ b/src/wm2/src/wm2_dhcp_table.c
@@ -0,0 +1,99 @@
+#include <stdlib.h>
+#include <sys/wait.h>
+#include <stdint.h>
+#include <errno.h>
+#include <limits.h>
+#include <string.h>
+#include <unistd.h>
+#include <arpa/inet.h>
+#include <netinet/in.h>
+#include <signal.h>
+#include <inttypes.h>
+#include <jansson.h>
+
+#include "json_util.h"
+#include "evsched.h"
+#include "schema.h"
+#include "log.h"
+#include "wm2.h"
+#include "ovsdb.h"
+#include "ovsdb_sync.h"
+
+#include "target.h"
+
+// Defines
+#define MODULE_ID LOG_MODULE_ID_MAIN
+
+// OVSDB constants
+#define OVSDB_DHCP_TABLE            "DHCP_leased_IP"
+
+static bool                         g_dhcp_table_init = false;
+
+/******************************************************************************
+ *  PROTECTED definitions
+ *****************************************************************************/
+static bool
+wm2_dhcp_table_update(struct schema_DHCP_leased_IP       *dlip)
+{
+    pjs_errmsg_t        perr;
+    json_t             *where, *row;
+    bool                ret;
+
+    LOGT("Updating DHCP lease '%s'",
+         dlip->hwaddr);
+
+    /* Skip deleting the empty entries at startup */
+    if(!g_dhcp_table_init && (dlip->lease_time == 0))
+    {
+        return true;
+    }
+
+    if (dlip->lease_time == 0)  {
+        // Released or expired lease... remove from OVSDB
+        where = ovsdb_tran_cond(OCLM_STR, "hwaddr", OFUNC_EQ, str_tolower(dlip->hwaddr));
+        ret = ovsdb_sync_delete_where(OVSDB_DHCP_TABLE, where);
+        if (!ret) {
+            LOGE("Updating DHCP lease %s (Failed to remove entry)",
+                dlip->hwaddr);
+            return false;
+        }
+        LOGN("Removed DHCP lease '%s' with '%s' '%s' '%d'",
+             dlip->hwaddr, dlip->inet_addr, dlip->hostname, dlip->lease_time);
+
+    }
+    else {
+        // New/active lease, upsert it into OVSDB
+        where = ovsdb_tran_cond(OCLM_STR, "hwaddr", OFUNC_EQ, str_tolower(dlip->hwaddr));
+        row   = schema_DHCP_leased_IP_to_json(dlip, perr);
+        ret = ovsdb_sync_upsert_where(OVSDB_DHCP_TABLE, where, row, NULL);
+        if (!ret) {
+            LOGE("Updating DHCP lease %s (Failed to insert entry)",
+                dlip->hwaddr);
+            return false;
+        }
+        LOGN("Updated DHCP lease '%s' with '%s' '%s' '%d'",
+             dlip->hwaddr, dlip->inet_addr, dlip->hostname, dlip->lease_time);
+
+    }
+
+    return true;
+}
+
+/******************************************************************************
+ *  PUBLIC definitions
+ *****************************************************************************/
+bool
+wm2_dhcp_table_init(void)
+{
+    bool         ret;
+
+    /* Register to DHCP lease changed ... */
+    ret = target_dhcp_leased_ip_register(wm2_dhcp_table_update);
+    if (false == ret) {
+        return false;
+    }
+
+    g_dhcp_table_init = true;
+
+    return true;
+}
diff --git a/src/wm2/src/wm2_main.c b/src/wm2/src/wm2_main.c
index 5e4d100..01775c9 100644
--- a/src/wm2/src/wm2_main.c
+++ b/src/wm2/src/wm2_main.c
@@ -107,6 +107,7 @@ main(int argc, char ** argv)
     }
 
     wm2_radio_init();
+    wm2_dhcp_table_init();
 
     ev_run(loop, 0);
 
diff --git a/src/wm2/unit.mk b/src/wm2/unit.mk
index 5119ed8..9a2a105 100644
--- a/src/wm2/unit.mk
+++ b/src/wm2/unit.mk
@@ -36,6 +36,7 @@ UNIT_SRC     := src/wm2_main.c
 UNIT_SRC     += src/wm2_radio.c
 UNIT_SRC     += src/wm2_radio1.c
 UNIT_SRC     += src/wm2_clients.c
+UNIT_SRC     += src/wm2_dhcp_table.c
 
 UNIT_CFLAGS  += -I$(TOP_DIR)/src/lib/common/inc/
 
-- 
1.9.1

